@startuml tri_diagram_v4
title Tri Version Control System - v4
skinparam linetype ortho

' ================================================
' DATA STRUCTURES
' ================================================

package "data_structures" {
    
    class "Node<T>" <<struct>> {
        + value: T
        + next: Node*
        + prev: Node*
        + Node(v: T)
    }

    class "iterator" {
        - p_: Node*
        + operator*() : T&
        + operator->() : T*
        + operator++() : iterator&
        + operator--() : iterator&
        + operator==(other: iterator) : bool
        + operator!=(other: iterator) : bool
    }

    class "DoublyLinkedList<T>" {
        ' Private Members
        - head_: Node*
        - tail_: Node*
        - size_: size_t
        
        ' Helpers
        - node_at(idx: size_t) : Node*
        - delete_node(node: Node*) : void
        - clear_internal() : void

        ' Rule of Five
        + DoublyLinkedList()
        + ~DoublyLinkedList()
        + DoublyLinkedList(other: DoublyLinkedList&)
        + operator=(other: DoublyLinkedList&)
        + DoublyLinkedList(other: DoublyLinkedList&&)
        + operator=(other: DoublyLinkedList&&)

        ' Operations
        + insert(idx: size_t, v: T) : void
        + push_back(v: T) : void
        + push_front(v: T) : void
        + pop_back() : void
        + pop_front() : void
        + remove(val: T) : bool
        + find(predicate: function) : iterator
        
        + begin() : iterator
        + end() : iterator
        + front() : T&
        + back() : T&
        + size() : size_t
        + empty() : bool
        + clear() : void
    }

    class "Stack<T>" {
        - list: DoublyLinkedList<T>
        
        + push(item: T)
        + pop() : void
        + top() : T&
        + empty() : bool
        + size() : size_t
    }

    class "Queue<T>" {
        - list: DoublyLinkedList<T>
        
        + enqueue(item: T)
        + dequeue() : void
        + front() : T&
        + empty() : bool
        + size() : size_t
    }

    class "HashEntry<K, V>" {
        + key: K
        + value: V
        + next: HashEntry*
    }

    class "HashTable<K, V>" {
        - buckets: HashEntry**
        - capacity: int
        - size: int
        - hashFunc(key: K) : int
        + put(key: K, val: V)
        + get(key: K) : V
        + contains(key: K) : bool
        + remove(key: K) : void
    }
}

' ================================================
' DOMAIN ENTITIES
' ================================================

package "entities" {
    class File {
        - string path
        - string content
        - string fileHash
        + calculateHash() : string
    }

    class Commit {
        - string id
        - string message
        - string author
        - long timestamp
        - string treeHash
        - Commit* parent1
        - Commit* parent2
        + getId() : string
    }

    class Branch {
        - string name
        - Commit* tip
        + getTip() : Commit*
        + update(c: Commit*)
    }
}

' ================================================
' CORE MODULES
' ================================================

package "core" {
    class StagingArea {
        - trackedFiles: DoublyLinkedList<File>
        + add(file: File)
        + remove(fileName: string)
        + getFiles() : DoublyLinkedList<File>
    }

    class GraphManager {
        - commitMap: HashTable<string, Commit*>
        + addCommit(c: Commit*)
        + getCommit(id: string) : Commit*
        + getAncestors(start: Commit*) : Stack<Commit*>
        + findLCA(c1: Commit*, c2: Commit*) : Commit*
    }

    class ReferenceManager {
        - branches: HashTable<string, Branch*>
        - currentBranch: Branch*
        - detachedHead: Commit*
        - isDetached: bool
        + createBranch(name: string, tip: Commit*)
        + getBranch(name: string) : Branch*
        + updateHead(target: string)
    }

    class MergeEngine {
        + threeWayMerge(base: Commit*, c1: Commit*, c2: Commit*) : MergeResult
        - detectConflicts(files1: List, files2: List) : List
    }

    class StorageEngine {
        + createSnapshot(files: DoublyLinkedList<File>) : string
        + getFilesFromSnapshot(treeHash: string) : DoublyLinkedList<File>
    }
}

' ================================================
' MAIN SYSTEM & INTERFACE
' ================================================

class Repository {
    - staging: StagingArea
    - graph: GraphManager
    - refs: ReferenceManager
    - storage: StorageEngine
    - merger: MergeEngine

    + init()
    + add(filePath: string)
    + commit(msg: string)
    + branch(name: string)
    + checkout(target: string)
    + merge(targetBranch: string)
    + log()
}

class CommandLineInterface {
    - repo: Repository
    + run()
    + parseCommand(input: string)
}

class Main {
    + main(args: string[])
}

' ================================================
' RELATIONSHIPS
' ================================================

Main --> CommandLineInterface
CommandLineInterface --> Repository

Repository *-- StagingArea
Repository *-- GraphManager
Repository *-- ReferenceManager
Repository *-- StorageEngine
Repository *-- MergeEngine

' Custom DS Relationships
' Nesting Relationships (Inner Classes)
' BU KISIM NESTED OLDUKLARINI GOSTERIR
"DoublyLinkedList<T>" +-- "Node<T>"
"DoublyLinkedList<T>" +-- "iterator"

' Composition Relationships (Stack/Queue use List)
"Stack<T>" *-- "DoublyLinkedList<T>"
"Queue<T>" *-- "DoublyLinkedList<T>"

"HashTable<K, V>" *-- "HashEntry<K, V>"

' Module Data Usage
StagingArea o-- "DoublyLinkedList<T>"
GraphManager o-- "HashTable<K, V>"
GraphManager ..> "Stack<T>"
ReferenceManager o-- "HashTable<K, V>"

' Entity Relationships
GraphManager o-- Commit
ReferenceManager o-- Branch
Branch --> Commit
Commit --> Commit

@enduml